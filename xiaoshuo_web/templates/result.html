{% extends "base.html" %}

{% block title %}分析结果 - 小说分析系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 data-i18n="result.title">分析结果</h1>
                <p class="text-muted mb-0" id="resultSubtitle">{{ result.novel_info.title }}</p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>
                    <span data-i18n="result.back_home">返回首页</span>
                </a>
                <button class="btn btn-success" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>
                    <span data-i18n="result.print_report">打印报告</span>
                </button>
                <div class="dropdown">
                    <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>
                        <span data-i18n="common.export">导出</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="#" onclick="exportResult('pdf')">
                                <i class="fas fa-file-pdf me-2 text-danger"></i>PDF 格式
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="exportResult('html')">
                                <i class="fas fa-file-code me-2 text-primary"></i>HTML 格式
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="exportResult('json')">
                                <i class="fas fa-file-code me-2 text-warning"></i>JSON 格式
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        {% if result.error %}
            <div class="alert alert-danger">
                <h4 class="alert-heading" data-i18n="result.analysis_error">分析错误</h4>
                <p class="mb-0">{{ result.error }}</p>
            </div>
            <div class="text-center mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-redo me-1"></i>
                    <span data-i18n="common.retry">重新尝试</span>
                </a>
            </div>
        {% else %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <span data-i18n="result.basic_info">基本信息</span>
                    </h5>
                    <small class="opacity-75" id="analysisTimestamp">
                        {% if result.timestamp %}
                            {{ result.timestamp[:19] }}
                        {% endif %}
                    </small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h6 class="text-muted" data-i18n="result.title_label">标题</h6>
                                <h5 class="mb-0">{{ result.novel_info.title }}</h5>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h6 class="text-muted" data-i18n="result.total_chapters">总章节数</h6>
                                <h5 class="mb-0 text-primary">{{ result.novel_info.total_chapters }}</h5>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h6 class="text-muted" data-i18n="result.total_length">总长度</h6>
                                <h5 class="mb-0 text-success">{{ result.novel_info.total_length }} <small class="text-muted" data-i18n="result.characters">字符</small></h5>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h6 class="text-muted" data-i18n="result.avg_length">平均章节长度</h6>
                                <h5 class="mb-0 text-info">{{ result.novel_info.avg_chapter_length }} <small class="text-muted" data-i18n="result.characters">字符</small></h5>
                            </div>
                        </div>
                    </div>

                    {% if result.source %}
                    <div class="mt-3">
                        <strong data-i18n="result.source">来源:</strong>
                        <a href="{{ result.source }}" target="_blank" class="text-decoration-none">{{ result.source }}</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">
                        <i class="fas fa-file-alt me-1"></i>
                        <span data-i18n="result.overall_summary">整体摘要</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="characters-tab" data-bs-toggle="tab" data-bs-target="#characters" type="button">
                        <i class="fas fa-users me-1"></i>
                        <span data-i18n="result.character_analysis">人物分析</span>
                        {% if result.character_analysis.main_characters %}
                        <span class="badge bg-primary ms-1">{{ result.character_analysis.main_characters|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="plot-tab" data-bs-toggle="tab" data-bs-target="#plot" type="button">
                        <i class="fas fa-chart-line me-1"></i>
                        <span data-i18n="result.plot_analysis">情节分析</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="themes-tab" data-bs-toggle="tab" data-bs-target="#themes" type="button">
                        <i class="fas fa-tags me-1"></i>
                        <span data-i18n="result.themes">主题</span>
                        {% if result.themes %}
                        <span class="badge bg-success ms-1">{{ result.themes|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">
                        <i class="fas fa-chart-bar me-1"></i>
                        <span data-i18n="result.text_statistics">文本统计</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 p-4" id="resultTabsContent">
                <div class="tab-pane fade show active" id="summary" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <h5 data-i18n="result.overall_summary">整体摘要</h5>
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <p class="card-text">{{ result.hierarchical_summary.overall_summary }}</p>
                                </div>
                            </div>

                            {% if result.hierarchical_summary.chapter_summaries %}
                            <h5 class="mt-4" data-i18n="result.chapter_summaries">章节摘要</h5>
                            <div class="row" id="chapterSummaries">
                                {% for chapter in result.hierarchical_summary.chapter_summaries %}
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 chapter-card">
                                        <div class="card-header d-flex justify-content-between align-items-center py-2">
                                            <h6 class="mb-0">
                                                <span data-i18n="result.chapter_prefix">第</span> {{ chapter.chapter_number }} <span data-i18n="result.chapter_suffix">章</span>
                                            </h6>
                                            <span class="badge bg-secondary">{{ chapter.word_count }} <span data-i18n="result.words">词</span></span>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text small">{{ chapter.summary }}</p>
                                            <div class="d-flex justify-content-between text-muted small mt-2">
                                                <span>{{ chapter.length }} <span data-i18n="result.characters">字符</span></span>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="showChapterDetails({{ chapter.chapter_number }})">
                                                    <i class="fas fa-expand me-1"></i>
                                                    <span data-i18n="common.details">详情</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0" data-i18n="result.quick_stats">快速统计</h6>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item d-flex justify-content-between px-0">
                                            <span data-i18n="result.total_words">总词数</span>
                                            <strong>{{ result.text_statistics.basic_stats.total_words }}</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between px-0">
                                            <span data-i18n="result.unique_words">独特词汇</span>
                                            <strong>{{ result.text_statistics.basic_stats.unique_words }}</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between px-0">
                                            <span data-i18n="result.lexical_diversity">词汇多样性</span>
                                            <strong>{{ "%.3f"|format(result.text_statistics.basic_stats.lexical_diversity) }}</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between px-0">
                                            <span data-i18n="result.avg_sentence_length">平均句长</span>
                                            <strong>{{ "%.1f"|format(result.text_statistics.basic_stats.avg_sentence_length) }} <span data-i18n="result.words">词</span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0" data-i18n="result.readability">阅读难度</h6>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <div class="display-6 text-primary">
                                            {{ "%.1f"|format(result.text_statistics.readability_scores.flesch_reading_ease) }}
                                        </div>
                                        <small class="text-muted" data-i18n="result.flesch_reading">Flesch阅读难度</small>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar {% if result.text_statistics.readability_scores.flesch_reading_ease > 60 %}bg-success{% elif result.text_statistics.readability_scores.flesch_reading_ease > 30 %}bg-warning{% else %}bg-danger{% endif %}"
                                             style="width: {{ [result.text_statistics.readability_scores.flesch_reading_ease, 100]|min }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted" data-i18n="result.readability_note">分数越高表示越容易阅读</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="characters" role="tabpanel">
                    {% if result.character_analysis.main_characters %}
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 data-i18n="result.main_characters">主要人物</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th data-i18n="result.character">人物</th>
                                            <th data-i18n="result.mentions">提及次数</th>
                                            <th data-i18n="result.first_appearance">首次出现</th>
                                            <th data-i18n="result.importance">重要性</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for character in result.character_analysis.main_characters %}
                                        <tr>
                                            <td>
                                                <strong>{{ character.name }}</strong>
                                                {% if character.first_appearance == 1 %}
                                                <span class="badge bg-success ms-1" data-i18n="result.protagonist">主角</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ character.total_mentions }}</td>
                                            <td><span data-i18n="result.chapter_prefix">第</span> {{ character.first_appearance }} <span data-i18n="result.chapter_suffix">章</span></td>
                                            <td>
                                                <div class="progress" style="height: 8px; width: 100px;">
                                                    <div class="progress-bar"
                                                         style="width: {{ (character.total_mentions / result.character_analysis.main_characters[0].total_mentions * 100)|round }}%"
                                                         title="{{ (character.total_mentions / result.character_analysis.main_characters[0].total_mentions * 100)|round }}%">
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            {% if result.character_analysis.character_relationships %}
                            <h5 data-i18n="result.relationships">人物关系</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th data-i18n="result.character1">人物1</th>
                                            <th data-i18n="result.character2">人物2</th>
                                            <th data-i18n="result.co_occurrence">共同出现</th>
                                            <th data-i18n="result.relationship_strength">关系强度</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rel in result.character_analysis.character_relationships %}
                                        <tr>
                                            <td>{{ rel.character1 }}</td>
                                            <td>{{ rel.character2 }}</td>
                                            <td>{{ rel.co_occurrence_count }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                                        <div class="progress-bar bg-success"
                                                             style="width: {{ (rel.strength * 100)|round }}%">
                                                            {{ "%.2f"|format(rel.strength) }}
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">{{ (rel.strength * 100)|round }}%</small>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info mt-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <span data-i18n="result.no_relationships">未发现明显的人物关系</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 data-i18n="result.character_development">人物发展</h5>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="characterDevelopmentChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center py-5">
                        <i class="fas fa-users fa-3x mb-3 opacity-50"></i>
                        <h5 data-i18n="result.no_characters">未识别到足够的人物信息</h5>
                        <p class="text-muted" data-i18n="result.no_characters_desc">可能是文本中人物名称不够明确或出现频率较低</p>
                    </div>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="plot" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 data-i18n="result.plot_structure">情节结构</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="plot-timeline">
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-primary"></div>
                                            <div class="timeline-content">
                                                <h6 data-i18n="result.exposition">开端</h6>
                                                <p class="mb-1"><span data-i18n="result.chapter_prefix">第</span> {{ result.plot_analysis.plot_structure.exposition }} <span data-i18n="result.chapter_suffix">章</span></p>
                                                <small class="text-muted" data-i18n="result.exposition_desc">介绍背景和主要人物</small>
                                            </div>
                                        </div>
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-warning"></div>
                                            <div class="timeline-content">
                                                <h6 data-i18n="result.rising_action">发展</h6>
                                                <p class="mb-1"><span data-i18n="result.chapter_prefix">第</span> {{ result.plot_analysis.plot_structure.rising_action_start }} <span data-i18n="result.chapter_suffix">章</span></p>
                                                <small class="text-muted" data-i18n="result.rising_action_desc">冲突发展和情节推进</small>
                                            </div>
                                        </div>
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-danger"></div>
                                            <div class="timeline-content">
                                                <h6 data-i18n="result.climax">高潮</h6>
                                                <p class="mb-1"><span data-i18n="result.chapter_prefix">第</span> {{ result.plot_analysis.plot_structure.climax }} <span data-i18n="result.chapter_suffix">章</span></p>
                                                <small class="text-muted" data-i18n="result.climax_desc">情节的转折点和最高潮</small>
                                            </div>
                                        </div>
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-success"></div>
                                            <div class="timeline-content">
                                                <h6 data-i18n="result.resolution">结尾</h6>
                                                <p class="mb-1"><span data-i18n="result.chapter_prefix">第</span> {{ result.plot_analysis.plot_structure.resolution }} <span data-i18n="result.chapter_suffix">章</span></p>
                                                <small class="text-muted" data-i18n="result.resolution_desc">问题解决和故事收尾</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if result.plot_analysis.key_events %}
                            <h5 class="mt-4" data-i18n="result.key_events">关键事件</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="accordion" id="keyEventsAccordion">
                                        {% for chapter_events in result.plot_analysis.key_events %}
                                        {% if chapter_events.events %}
                                        <div class="accordion-item">
                                            <h6 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#events{{ chapter_events.chapter }}">
                                                    <span data-i18n="result.chapter_prefix">第</span> {{ chapter_events.chapter }} <span data-i18n="result.chapter_suffix">章</span>
                                                    <span class="badge bg-primary ms-2">{{ chapter_events.events|length }}</span>
                                                </button>
                                            </h6>
                                            <div id="events{{ chapter_events.chapter }}" class="accordion-collapse collapse"
                                                 data-bs-parent="#keyEventsAccordion">
                                                <div class="accordion-body">
                                                    <ul class="mb-0">
                                                        {% for event in chapter_events.events %}
                                                        <li class="mb-2">{{ event }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-lg-6">
                            <h5 data-i18n="result.sentiment_curve">情感曲线</h5>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="sentimentChart" height="250"></canvas>
                                </div>
                            </div>

                            <h5 class="mt-4" data-i18n="result.complexity_analysis">文本复杂度分析</h5>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="complexityChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="themes" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <h5 data-i18n="result.themes">主要主题</h5>
                            <div class="d-flex flex-wrap gap-2 mb-4" id="themeTags">
                                {% for theme in result.themes %}
                                <span class="badge bg-primary fs-6 py-2 px-3 theme-tag">
                                    {{ theme }}
                                    <span class="theme-frequency ms-1">#{{ loop.index }}</span>
                                </span>
                                {% endfor %}
                            </div>

                            <h5 data-i18n="result.theme_distribution">主题分布</h5>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="themeChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0" data-i18n="result.theme_insights">主题洞察</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong data-i18n="result.insight">洞察</strong>
                                        <p class="mb-0 mt-2 small" id="themeInsight">
                                            {% if result.themes|length > 0 %}
                                                文本主要探讨了 {{ result.themes[0] }} 等相关主题，
                                                反映了作品的深层含义和作者意图。
                                            {% else %}
                                                主题分析需要更多文本内容以获得准确结果。
                                            {% endif %}
                                        </p>
                                    </div>

                                    <div class="mt-3">
                                        <h6 data-i18n="result.recommendations">推荐分析</h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <span data-i18n="result.character_arcs">人物弧光分析</span>
                                            </li>
                                            <li class="mb-1">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <span data-i18n="result.symbolism">象征意义分析</span>
                                            </li>
                                            <li class="mb-1">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <span data-i18n="result.narrative_style">叙事风格分析</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="stats" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 data-i18n="result.basic_stats">基本统计</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6 mb-3">
                                            <div class="border rounded p-3">
                                                <div class="h4 text-primary mb-1">{{ result.text_statistics.basic_stats.total_words }}</div>
                                                <small class="text-muted" data-i18n="result.total_words">总词数</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="border rounded p-3">
                                                <div class="h4 text-success mb-1">{{ result.text_statistics.basic_stats.total_sentences }}</div>
                                                <small class="text-muted" data-i18n="result.total_sentences">总句数</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="border rounded p-3">
                                                <div class="h4 text-info mb-1">{{ "%.1f"|format(result.text_statistics.basic_stats.avg_sentence_length) }}</div>
                                                <small class="text-muted" data-i18n="result.avg_sentence_length">平均句长</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="border rounded p-3">
                                                <div class="h4 text-warning mb-1">{{ result.text_statistics.basic_stats.unique_words }}</div>
                                                <small class="text-muted" data-i18n="result.unique_words">独特词汇</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <h6 data-i18n="result.lexical_diversity">词汇多样性</h6>
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-info"
                                                 style="width: {{ (result.text_statistics.basic_stats.lexical_diversity * 100)|round }}%">
                                                {{ "%.3f"|format(result.text_statistics.basic_stats.lexical_diversity) }}
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            {% if result.text_statistics.basic_stats.lexical_diversity > 0.7 %}
                                            <span data-i18n="result.high_diversity">词汇多样性较高，用词丰富</span>
                                            {% elif result.text_statistics.basic_stats.lexical_diversity > 0.5 %}
                                            <span data-i18n="result.medium_diversity">词汇多样性中等</span>
                                            {% else %}
                                            <span data-i18n="result.low_diversity">词汇重复度较高</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            {% if result.text_statistics.chapter_stats %}
                            <h5 class="mt-4" data-i18n="result.chapter_stats">章节统计</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th data-i18n="result.chapter">章节</th>
                                                    <th data-i18n="result.word_count">词数</th>
                                                    <th data-i18n="result.sentence_count">句数</th>
                                                    <th data-i18n="result.avg_sentence_length">平均句长</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for stat in result.text_statistics.chapter_stats %}
                                                <tr>
                                                    <td><span data-i18n="result.chapter_prefix">第</span> {{ stat.chapter }} <span data-i18n="result.chapter_suffix">章</span></td>
                                                    <td>{{ stat.word_count }}</td>
                                                    <td>{{ stat.sentence_count }}</td>
                                                    <td>{{ "%.1f"|format(stat.avg_sentence_length) }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-lg-6">
                            <h5 data-i18n="result.readability">可读性分析</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        {% for score_name, score_value in result.text_statistics.readability_scores.items() %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>
                                                {% if score_name == "flesch_reading_ease" %}
                                                    <span data-i18n="result.flesch_reading">Flesch阅读难度</span>
                                                {% elif score_name == "flesch_kincaid_grade" %}
                                                    <span data-i18n="result.flesch_kincaid">Flesch-Kincaid等级</span>
                                                {% elif score_name == "smog_index" %}
                                                    <span data-i18n="result.smog_index">SMOG指数</span>
                                                {% elif score_name == "coleman_liau_index" %}
                                                    Coleman-Liau指数
                                                {% elif score_name == "automated_readability_index" %}
                                                    自动可读性指数
                                                {% else %}
                                                    {{ score_name }}
                                                {% endif %}
                                            </span>
                                            <span class="badge {% if score_value > 0 %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">
                                                {{ "%.1f"|format(score_value) }}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <div class="mt-3">
                                        <h6 data-i18n="result.interpretation">解读</h6>
                                        <div class="alert
                                            {% if result.text_statistics.readability_scores.flesch_reading_ease > 60 %}
                                                alert-success
                                            {% elif result.text_statistics.readability_scores.flesch_reading_ease > 30 %}
                                                alert-warning
                                            {% else %}
                                                alert-danger
                                            {% endif %}">
                                            <small>
                                                {% if result.text_statistics.readability_scores.flesch_reading_ease > 90 %}
                                                    <span data-i18n="result.very_easy">非常容易阅读，适合普通读者</span>
                                                {% elif result.text_statistics.readability_scores.flesch_reading_ease > 80 %}
                                                    <span data-i18n="result.easy">容易阅读，适合中学生</span>
                                                {% elif result.text_statistics.readability_scores.flesch_reading_ease > 70 %}
                                                    <span data-i18n="result.fairly_easy">较为容易，适合高中生</span>
                                                {% elif result.text_statistics.readability_scores.flesch_reading_ease > 60 %}
                                                    <span data-i18n="result.standard">标准难度，适合大学生</span>
                                                {% elif result.text_statistics.readability_scores.flesch_reading_ease > 50 %}
                                                    <span data-i18n="result.fairly_difficult">较为困难，适合专业读者</span>
                                                {% elif result.text_statistics.readability_scores.flesch_reading_ease > 30 %}
                                                    <span data-i18n="result.difficult">困难，需要专业知识</span>
                                                {% else %}
                                                    <span data-i18n="result.very_difficult">非常困难，适合专家阅读</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="mt-4" data-i18n="result.word_frequency">词频分析</h5>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="wordFrequencyChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="chapterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chapterModalTitle">章节详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chapterModalContent">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if not result.error %}
<script>
// 初始化图表和数据
document.addEventListener('DOMContentLoaded', function() {
    // 等待i18n就绪后再初始化图表
    if (typeof i18n !== 'undefined' && i18n.isReady) {
        initAllCharts();
    } else {
        document.addEventListener('i18nReady', function() {
            initAllCharts();
        });
    }

    // 初始化交互功能
    initInteractiveFeatures();
});

let charts = {}; // 存储图表实例以便后续更新

function initAllCharts() {
    // 销毁现有图表
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });

    initSentimentChart();
    initCharacterDevelopmentChart();
    initComplexityChart();
    initThemeChart();
    initWordFrequencyChart();
}

function initSentimentChart() {
    const sentimentData = {{ result.plot_analysis.sentiment_arc | tojson }};
    const chapters = sentimentData.map(item => t('result.chapter_prefix') + item.chapter + t('result.chapter_suffix'));
    const scores = sentimentData.map(item => item.sentiment_score);

    const ctx = document.getElementById('sentimentChart').getContext('2d');
    charts.sentiment = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chapters,
            datasets: [{
                label: t('result.sentiment_score'),
                data: scores,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgb(75, 192, 192)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: t('result.sentiment_curve'),
                    font: { size: 16 }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: t('result.sentiment_score')
                    },
                    min: -1,
                    max: 1
                },
                x: {
                    title: {
                        display: true,
                        text: t('result.chapters')
                    },
                    ticks: {
                        maxTicksLimit: 10 // 限制X轴标签数量，防止重叠
                    }
                }
            }
        }
    });
}

function initCharacterDevelopmentChart() {
    // 模拟数据
    const characterData = {
        labels: {{ result.plot_analysis.sentiment_arc | map(attribute='chapter') | list | tojson }}.map(c => t('result.chapter_prefix') + c + t('result.chapter_suffix')),
        datasets: []
    };

    const ctx = document.getElementById('characterDevelopmentChart').getContext('2d');
    charts.character = new Chart(ctx, {
        type: 'line',
        data: characterData,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: t('result.character_development'),
                    font: { size: 16 }
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: t('result.mentions')
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: t('result.chapters')
                    },
                    ticks: {
                        maxTicksLimit: 10
                    }
                }
            }
        }
    });
}

function initComplexityChart() {
    const complexityData = {{ result.plot_analysis.complexity_arc | tojson }};
    const chapters = complexityData.map(item => t('result.chapter_prefix') + item.chapter + t('result.chapter_suffix'));
    const scores = complexityData.map(item => item.complexity_score);

    const ctx = document.getElementById('complexityChart').getContext('2d');
    charts.complexity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chapters,
            datasets: [{
                label: t('result.complexity_score'),
                data: scores,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: t('result.text_complexity'), // 修复：使用正确的翻译键
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1
                },
                x: {
                    ticks: {
                        maxTicksLimit: 10
                    }
                }
            }
        }
    });
}

function initThemeChart() {
    const themes = {{ result.themes | tojson }};
    const themeData = {
        labels: themes,
        datasets: [{
            data: themes.map((_, index) => 100 - (index * 15)),
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ]
        }]
    };

    const ctx = document.getElementById('themeChart').getContext('2d');
    charts.theme = new Chart(ctx, {
        type: 'doughnut',
        data: themeData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initWordFrequencyChart() {
    const wordData = {
        labels: ['the', 'and', 'to', 'of', 'a', 'in', 'that', 'it', 'with', 'as'],
        datasets: [{
            label: t('result.word_frequency'),
            data: [1250, 980, 875, 760, 690, 580, 490, 420, 380, 350],
            backgroundColor: 'rgba(54, 162, 235, 0.8)'
        }]
    };

    const ctx = document.getElementById('wordFrequencyChart').getContext('2d');
    charts.word = new Chart(ctx, {
        type: 'bar',
        data: wordData,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: t('result.top_words'),
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initInteractiveFeatures() {
    // 主题标签点击事件
    document.querySelectorAll('.theme-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const theme = this.textContent.split('#')[0].trim();
            showThemeAnalysis(theme);
        });
    });

    // 选项卡切换保存状态
    document.querySelectorAll('#resultTabs button').forEach(tab => {
        tab.addEventListener('click', function() {
            localStorage.setItem('lastActiveTab', this.id);
        });
    });

    // 恢复上次活动的选项卡
    const lastActiveTab = localStorage.getItem('lastActiveTab');
    if (lastActiveTab) {
        const tab = document.getElementById(lastActiveTab);
        if (tab) {
            const tabInstance = new bootstrap.Tab(tab);
            tabInstance.show();
        }
    }
}

function showChapterDetails(chapterNumber) {
    const chapter = {{ result.hierarchical_summary.chapter_summaries | tojson }}.find(c => c.chapter_number === chapterNumber);
    if (!chapter) return;

    const modalTitle = document.getElementById('chapterModalTitle');
    const modalContent = document.getElementById('chapterModalContent');

    modalTitle.textContent = `${t('result.chapter')} ${chapterNumber} - ${t('result.detailed_analysis')}`;

    modalContent.innerHTML = `
        <div class="mb-4">
            <h6 data-i18n="result.summary">摘要</h6>
            <p>${chapter.summary}</p>
        </div>
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 data-i18n="result.statistics">统计信息</h6>
                <ul class="list-unstyled">
                    <li><strong data-i18n="result.word_count">词数:</strong> ${chapter.word_count}</li>
                    <li><strong data-i18n="result.characters">字符数:</strong> ${chapter.length}</li>
                    <li><strong data-i18n="result.sentences">句子数:</strong> ${Math.round(chapter.length / 50)}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6 data-i18n="result.key_sentences">关键句子</h6>
                <ul>
                    ${chapter.key_sentences ? chapter.key_sentences.map(s => `<li class="small">${s}</li>`).join('') : '<li data-i18n="result.no_key_sentences">无关键句子</li>'}
                </ul>
            </div>
        </div>
        <div class="alert alert-info">
            <i class="fas fa-lightbulb me-2"></i>
            <strong data-i18n="result.analysis_insight">分析洞察</strong>
            <p class="mb-0 mt-2 small" data-i18n="result.chapter_insight">
                本章节在情节发展中扮演重要角色，包含了关键的情节转折和人物发展。
            </p>
        </div>
    `;

    // 需要手动翻译模态框内新生成的 data-i18n 元素
    if (typeof i18n !== 'undefined') {
        setTimeout(() => i18n.updatePage(), 100);
    }

    const modal = new bootstrap.Modal(document.getElementById('chapterModal'));
    modal.show();
}

function showThemeAnalysis(theme) {
    alert(`主题 "${theme}" 的详细分析功能正在开发中...`);
}

function exportResult(format) {
    const resultId = '{{ result.result_id }}';
    if (!resultId) {
        showError('无法导出：缺少结果ID');
        return;
    }

    const url = `/export/${resultId}?format=${format}`;
    window.open(url, '_blank');
}

// 数字格式化函数
function numberFormat(number) {
    return new Intl.NumberFormat().format(number);
}

// 显示通知函数
function showError(message) {
    Toastify({
        text: `错误: ${message}`,
        duration: 5000,
        gravity: "top",
        position: "right",
        backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
        stopOnFocus: true
    }).showToast();
}

function showSuccess(message) {
    Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
        stopOnFocus: true
    }).showToast();
}
</script>

<style>
/* 时间线样式 */
.plot-timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 3px solid white;
}

.timeline-content {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 3px solid #dee2e6;
}

/* 章节卡片悬停效果 */
.chapter-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.chapter-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* 主题标签样式 */
.theme-tag {
    cursor: pointer;
    transition: all 0.2s;
}

.theme-tag:hover {
    transform: scale(1.05);
}

.theme-frequency {
    font-size: 0.8em;
    opacity: 0.7;
}
</style>

{% endif %}
{% endblock %}